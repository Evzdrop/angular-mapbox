angular.module("angular-mapbox",[]).service("mapboxService",["$timeout",function(e){function a(e){e=e||{},L.mapbox.accessToken=e.accessToken}function o(e,a,o){a=a||{},this.mapInstances[n(e)]={map:e,options:a,markers:o}}function n(e){return e._container.id}function r(e){delete this.mapInstances[n(e)]}function t(){return this.mapInstances}function i(e){return this.mapInstances[e].map}function s(e){return this.mapInstances[n(e)]?this.mapInstances[n(e)].markers:void 0}function c(e){return this.mapInstances[n(e)]?this.mapInstances[n(e)].options:void 0}function l(a,o){e(function(){var e=new L.featureGroup(o);a.fitBounds(e.getBounds()),a.getZoom()>15&&a.setZoom(15)}.bind(this),200)}function p(e,a){var o=this.mapInstances[n(e)],r=o.markers,t=o.options;r.push(a),this.mapInstances[n(e)].markers=r,t.scaleToFit&&this.fitMapToMarkers(e,r)}function u(e,a){var o,r=this.getMarkersForMap(e);if(r){var t=this.getOptionsForMap(e),i=t.clusterGroup;if(i)return void i.removeLayer(a);e.removeLayer(a);for(var s=0;r[s];s++)r[s]._leaflet_id===a._leaflet_id&&(o=s);r.splice(o,1),t.scaleToFit&&t.scaleToFitAll&&this.fitMapToMarkers(e,r),this.mapInstances[n(e)].markers=r}}var m={};return{init:a,getMapInstances:t,addMapInstance:o,removeMapInstance:r,getMarkersForMap:s,addMarker:p,removeMarker:u,fitMapToMarkers:l,getOptionsForMap:c,getMapInstance:i,mapInstances:m}}]).directive("mapbox",["$q","$parse","$timeout","mapboxService",function(e,a,o,n){return{restrict:"E",transclude:!0,scope:{onReposition:"&?",onZoom:"&?",onClick:"&?"},replace:!0,template:'<div class="angular-mapbox-map" ng-transclude></div>',link:function(e,a,r){var t=a[0];t.id=r.id,e.map=L.mapbox.map(t,r.mapId),e.markers=[],e.featureLayers=[];var i={clusterMarkers:void 0!==r.clusterMarkers,scaleToFit:void 0!==r.scaleToFit,scaleToFitAll:"all"===r.scaleToFit};if(void 0!==i.clusterMarkers&&(i.clusterGroup=new L.MarkerClusterGroup({disableClusteringAtZoom:18,removeOutsideVisibleBounds:!0,showCoverageOnHover:!1}),e.map.featureLayer.on("ready",function(e){e.target.eachLayer(function(e){i.clusterGroup.addLayer(e)})}),e.map.addLayer(i.clusterGroup)),n.addMapInstance(e.map,i,e.markers),"false"===r.dragging&&e.map.dragging.disable(),"false"===r.touchZoom&&e.map.touchZoom.disable(),"false"===r.doubleClickZoom&&e.map.doubleClickZoom.disable(),"false"===r.scrollWheelZoom&&e.map.scrollWheelZoom.disable(),void 0===r.autoSize){var s=r.width||"100",c=r.height||500;isNaN(s)?a.css("width",s):a.css("width",s+"%"),isNaN(c)?a.css("height",c):a.css("height",c+"px")}e.onReposition&&e.map.on("dragend",function(a){o(function(){e.onReposition({event:a,map:e.map})})}),e.onZoom&&e.map.on("zoomend",function(a){o(function(){e.onZoom({event:a,map:e.map})})}),e.onClick&&e.map.on("click",function(a){o(function(){e.onClick({event:a,map:e.map})})});var l=function(){var a=r.zoom||12;r.lat&&r.lng?e.map.setView([r.lat,r.lng],a):e.map.setZoom(a)};r.$observe("lat",l),r.$observe("lng",l),r.$observe("zoom",l),a.bind("$destroy",function(){n.removeMapInstance(e.map)}),l()}}}]).directive("marker",["$compile","$timeout","mapboxService",function(e,a,o){return{restrict:"E",scope:{onClick:"&",marker:"="},link:function(e,a,n){function r(e){return e.iconUrl?L.icon({iconUrl:e.iconUrl,iconSize:e.iconSize.split(","),iconAnchor:[20,30]}):L.icon()}function t(e,a,n,r){r=r||{};var t=L.marker(n,r);return o.getOptionsForMap(a).clusterMarkers&&r.excludeFromClustering!==!0?o.getOptionsForMap(a).clusterGroup.addLayer(t):t.addTo(a),r.draggable&&t.dragging.enable(),r.clickable&&(t.options.clickable=!1),o.addMarker(a,t),t}var i,s;s={draggable:void 0!==n.draggable,clickable:void 0!==n.clickable,icon:r(n),bounceOnAdd:void 0!==n.bounce,bounceOnAddOptions:{duration:600,height:-.5}};var c=o.getMapInstance(n.id);i=t(e,c,[n.lat,n.lng],s),e.onClick&&i.on("click",function(){e.onClick({marker:e.marker})}),a.bind("$destroy",function(){o.getOptionsForMap(c)&&o.getOptionsForMap(c).clusterMarkers?o.getOptionsForMap(c).clusterGroup.removeLayer(i):o.removeMarker(c,i)})}}}]);