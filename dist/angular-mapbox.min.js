angular.module("angular-mapbox",[]).service("mapboxService",["$timeout","$http",function(e,o){function a(e){this.opts=e||{},L.mapbox.accessToken=e.accessToken}function n(e,a,n,t,r,i){t=_.extend({access_token:r},t),o({method:"GET",url:"https://api.mapbox.com/"+e+"/v5/"+a+"/"+n+".json",params:t}).then(function(e){i(e)},function(e){i(e)})}function t(e,o){n("geocoding","mapbox.places",e,"autocomplete=true",this.opts.accessToken,function(e){o(e.data)})}function r(e,o,a){o=o||{},this.mapInstances[i(e)]={map:e,options:o,markers:a}}function i(e){return e._container.id}function s(e){delete this.mapInstances[i(e)]}function c(){return this.mapInstances}function l(e){return this.mapInstances[e].map}function p(e){return this.mapInstances[i(e)]?this.mapInstances[i(e)].markers:void 0}function u(e){return this.mapInstances[i(e)]?this.mapInstances[i(e)].options:void 0}function m(o,a){e(function(){var e=new L.featureGroup(a);o.fitBounds(e.getBounds()),o.getZoom()>15&&o.setZoom(15)}.bind(this),200)}function d(e,o){var a=this.mapInstances[i(e)],n=a.markers,t=a.options;n.push(o),this.mapInstances[i(e)].markers=n,t.scaleToFit&&this.fitMapToMarkers(e,n)}function f(e,o){var a,n=this.getMarkersForMap(e);if(n){var t=this.getOptionsForMap(e),r=t.clusterGroup;if(t.clusterMarkers)return void r.removeLayer(o);e.removeLayer(o);for(var s=0;n[s];s++)n[s]._leaflet_id===o._leaflet_id&&(a=s);n.splice(a,1),t.scaleToFit&&t.scaleToFitAll&&this.fitMapToMarkers(e,n),this.mapInstances[i(e)].markers=n}}function v(e,o,a){this.clearCircles(e);var n=L.circle(o,a);this.opts.layer=n,n.addTo(e)}function g(e){this.opts.layer&&e.removeLayer(this.opts.layer)}function k(e,o,a){e.setView(o,a)}var h={},b={};return{init:a,getMapInstances:c,addMapInstance:r,removeMapInstance:s,getMarkersForMap:p,addMarker:d,removeMarker:f,fitMapToMarkers:m,getOptionsForMap:u,getMapInstance:l,mapInstances:h,drawCircle:v,geocode:t,opts:b,setView:k,clearCircles:g}}]).directive("mapbox",["$q","$parse","$timeout","mapboxService",function(e,o,a,n){return{restrict:"E",transclude:!0,scope:{onReposition:"&?",onZoom:"&?",onClick:"&?"},replace:!0,template:'<div class="angular-mapbox-map" ng-transclude></div>',link:function(e,o,t){var r=o[0];r.id=t.id,e.map=L.mapbox.map(r,t.mapId),e.markers=[],e.featureLayers=[];var i={clusterMarkers:void 0!==t.clusterMarkers,scaleToFit:void 0!==t.scaleToFit,scaleToFitAll:"all"===t.scaleToFit};if(void 0!==i.clusterMarkers&&(i.clusterGroup=new L.MarkerClusterGroup({disableClusteringAtZoom:18,removeOutsideVisibleBounds:!0,showCoverageOnHover:!1}),e.map.featureLayer.on("ready",function(e){e.target.eachLayer(function(e){i.clusterGroup.addLayer(e)})}),e.map.addLayer(i.clusterGroup)),n.addMapInstance(e.map,i,e.markers),"false"===t.dragging&&e.map.dragging.disable(),"false"===t.touchZoom&&e.map.touchZoom.disable(),"false"===t.doubleClickZoom&&e.map.doubleClickZoom.disable(),"false"===t.scrollWheelZoom&&e.map.scrollWheelZoom.disable(),void 0===t.autoSize){var s=t.width||"100",c=t.height||500;isNaN(s)?o.css("width",s):o.css("width",s+"%"),isNaN(c)?o.css("height",c):o.css("height",c+"px")}e.onReposition&&e.map.on("dragend",function(o){a(function(){e.onReposition({event:o,map:e.map})})}),e.onZoom&&e.map.on("zoomend",function(o){a(function(){e.onZoom({event:o,map:e.map})})}),e.onClick&&e.map.on("click",function(o){a(function(){e.onClick({event:o,map:e.map})})});var l=function(){var o=t.zoom||12;t.lat&&t.lng?e.map.setView([t.lat,t.lng],o):e.map.setZoom(o)};t.$observe("lat",l),t.$observe("lng",l),t.$observe("zoom",l),o.bind("$destroy",function(){n.removeMapInstance(e.map)}),l()}}}]).directive("marker",["$compile","$timeout","mapboxService",function(e,o,a){return{restrict:"E",scope:{onClick:"&",marker:"="},link:function(e,o,n){function t(e){return e.iconUrl?L.icon({iconUrl:e.iconUrl,iconSize:e.iconSize.split(","),iconAnchor:[20,30]}):L.icon()}function r(e,o,n,t){t=t||{};var r=L.marker(n,t);return a.getOptionsForMap(o).clusterMarkers&&t.excludeFromClustering!==!0?a.getOptionsForMap(o).clusterGroup.addLayer(r):r.addTo(o),t.draggable&&r.dragging.enable(),t.clickable&&(r.options.clickable=!1),a.addMarker(o,r),r}var i,s;s={draggable:void 0!==n.draggable,clickable:void 0!==n.clickable,icon:t(n),bounceOnAdd:void 0!==n.bounce,bounceOnAddOptions:{duration:600,height:-.5}};var c=a.getMapInstance(n.id);i=r(e,c,[n.lat,n.lng],s),e.onClick&&i.on("click",function(){e.onClick({marker:e.marker})}),o.bind("$destroy",function(){a.getOptionsForMap(c)&&a.getOptionsForMap(c).clusterMarkers?a.getOptionsForMap(c).clusterGroup.removeLayer(i):a.removeMarker(c,i)})}}}]);
