angular.module("angular-mapbox",[]).service("mapboxService",["$timeout",function(e){function a(e){e=e||{},L.mapbox.accessToken=e.accessToken}function n(e,a,n){a=a||{},this.mapInstances.push(e),this.mapOptions.push(a),this.markers.push(n||[]),this.mapInstanceMapped[o(e)]=e}function o(e){return e._container.id}function t(e){var a=this.mapInstances.indexOf(e);delete this.mapInstanceMapped[o(e)],a>=0&&(this.mapInstances.splice(a,1),this.mapOptions.splice(a,1),this.markers.splice(a,1))}function i(){return this.mapInstances}function r(e){return this.mapInstanceMapped[e]}function s(e){var a=this.mapInstances.indexOf(e);return this.markers[a]}function c(e){var a=this.mapInstances.indexOf(e);return this.mapOptions[a]}function p(a,n){e(function(){var e=new L.featureGroup(n);a.fitBounds(e.getBounds()),a.getZoom()>15&&a.setZoom(15)}.bind(this),200)}function l(e,a){var n=this.mapInstances.indexOf(e),o=this.markers[n],t=this.mapOptions[n];o.push(a),t.scaleToFit&&p(e,o)}function m(e,a){e.removeLayer(a);var n,o=this.getMarkersForMap(e);if(o){for(var t=0;o[t];t++)o[t]._leaflet_id===a._leaflet_id&&(n=t);o.splice(n,1);var i=c(e);i.scaleToFit&&i.scaleToFitAll&&p(e,o)}}var u=[],d=[],f=[],v={};return{init:a,getMapInstances:i,addMapInstance:n,removeMapInstance:t,getMarkersForMap:s,addMarker:l,removeMarker:m,fitMapToMarkers:p,getOptionsForMap:c,getMapInstance:r,mapInstances:u,markers:f,mapOptions:d,mapInstanceMapped:v}}]).directive("mapbox",["$q","$parse","$timeout","mapboxService",function(e,a,n,o){return{restrict:"E",transclude:!0,scope:{onReposition:"&?",onZoom:"&?",onClick:"&?"},replace:!0,template:'<div class="angular-mapbox-map" ng-transclude></div>',link:function(e,a,t){var i=a[0];i.id=t.id,e.map=L.mapbox.map(i,t.mapId),e.markers=[],e.featureLayers=[];var r={clusterMarkers:void 0!==t.clusterMarkers,scaleToFit:void 0!==t.scaleToFit,scaleToFitAll:"all"===t.scaleToFit};if(void 0!==r.clusterMarkers&&(r.clusterGroup=new L.MarkerClusterGroup,e.map.addLayer(r.clusterGroup)),o.addMapInstance(e.map,r,e.markers),"false"===t.dragging&&e.map.dragging.disable(),"false"===t.touchZoom&&e.map.touchZoom.disable(),"false"===t.doubleClickZoom&&e.map.doubleClickZoom.disable(),"false"===t.scrollWheelZoom&&e.map.scrollWheelZoom.disable(),void 0===t.autoSize){var s=t.width||"100",c=t.height||500;isNaN(s)?a.css("width",s):a.css("width",s+"%"),isNaN(c)?a.css("height",c):a.css("height",c+"px")}e.onReposition&&e.map.on("dragend",function(a){n(function(){e.onReposition({event:a,map:e.map})})}),e.onZoom&&e.map.on("zoomend",function(a){n(function(){e.onZoom({event:a,map:e.map})})}),e.onClick&&e.map.on("click",function(a){n(function(){e.onClick({event:a,map:e.map})})});var p=function(){var a=t.zoom||12;t.lat&&t.lng?e.map.setView([t.lat,t.lng],a):e.map.setZoom(a)};t.$observe("lat",p),t.$observe("lng",p),t.$observe("zoom",p),a.bind("$destroy",function(){o.removeMapInstance(e.map)}),p()}}}]).directive("marker",["$compile","$timeout","mapboxService",function(e,a,n){return{restrict:"E",scope:{onClick:"&",marker:"="},link:function(e,a,o){function t(e){return e.iconUrl?L.icon({iconUrl:e.iconUrl,iconSize:e.iconSize.split(","),iconAnchor:[20,30]}):L.icon()}function i(e,a,o,t){t=t||{};var i=L.marker(o,t);return n.getOptionsForMap(a).clusterMarkers&&t.excludeFromClustering!==!0?n.getOptionsForMap(a).clusterGroup.addLayer(i):i.addTo(a),t.draggable&&i.dragging.enable(),t.clickable&&(i.options.clickable=!1),n.addMarker(a,i),i}var r,s;s={draggable:void 0!==o.draggable,clickable:void 0!==o.clickable,icon:t(o),bounceOnAdd:void 0!==o.bounce,bounceOnAddOptions:{duration:300,height:-3}};var c=n.getMapInstance(o.id);r=i(e,c,[o.lat,o.lng],s),e.onClick&&r.on("click",function(){e.onClick({marker:e.marker})}),a.bind("$destroy",function(){n.getOptionsForMap(c)&&n.getOptionsForMap(c).clusterMarkers?n.getOptionsForMap(c).clusterGroup.removeLayer(r):n.removeMarker(c,r)})}}}]);